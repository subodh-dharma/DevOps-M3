- hosts: canary
  sudo: yes
  user: ubuntu
  gather_facts: False
  pre_tasks:
  - name: Install python2
    raw: sudo apt-get -y install python-simplejson

  - name: Clear directory
    raw: rm -rf /home/canary

  tasks:

  - name: Install NodeJS
    apt: pkg=nodejs state=installed update_cache=yes

  - name: Install npm
    apt: pkg=npm state=installed update_cache=yes

  - name: Install git
    apt: pkg=git state=installed update_cache=yes

  - name: Install stress package for stress testing
    apt: pkg=stress state=installed update_cache=yes

  - name: Resolving node and nodejs
    command: ln -s /usr/bin/nodejs /usr/bin/node creates=/usr/bin/node

  - name: Install forever
    shell: npm install forever -g

  - name: Create Project folder
    file: path=/home/canary state=directory

  - name: Copying Server Software
    git: repo=https://github.com/subodh-dharma/DevOps-M3.git dest=/home/canary version=canary

  - name: Create Log files setup
    file: path=/home/canary/logs state=directory

  - name: Installing Server Software
    shell: npm --prefix /home/canary install

  - name: Clear Server data from Redis
    raw: node /home/canary/main clearRedis

  - name: Stop all forever processes
    raw: forever stopall

  - name: Starting Web Server
    command: forever start -l /home/canary/logs/forever.log -o /home/canary/logs/out.log -e /home/canary/logs/err.log /home/canary/main.js canaryRelease {{hostvars['redis']['ansible_host']}}

  - name: Install nginx
    apt: pkg=nginx state=installed update_cache=yes

  - name: Copy nginx configuration
    template: src=default dest=/etc/nginx/sites-available/default

  - name: Restart nginx
    service: name=nginx state=restarted

  - name: Allow nginx traffic through firewall
    ufw: rule=allow name='Nginx Full'

  # - name: Starting Request Monitoring services
  #  raw: su ubuntu -c "forever start /home/production/monitor_requests.js"

  - name: Starting Memory Monitoring services
    raw: forever start -l /home/canary/logs/mon_forever.log -o /home/canary/logs/mon_out.log -e /home/canary/logs/mon_err.log /home/canary/monitor_memory.js
